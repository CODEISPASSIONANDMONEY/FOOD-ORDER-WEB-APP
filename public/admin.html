<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Food Ordering System</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .admin-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .admin-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2.5rem;
      }

      .admin-header p {
        margin: 0;
        opacity: 0.9;
      }

      .admin-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .admin-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .admin-card h2 {
        margin-top: 0;
        color: #333;
        font-size: 1.5rem;
        border-bottom: 3px solid #667eea;
        padding-bottom: 0.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #555;
        font-weight: 600;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .image-upload-area {
        border: 2px dashed #e0e0e0;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .image-upload-area:hover {
        border-color: #667eea;
        background: #f8f9ff;
      }

      .image-upload-area.dragover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .image-preview {
        max-width: 100%;
        max-height: 200px;
        margin-top: 1rem;
        border-radius: 8px;
        display: none;
      }

      .image-preview.show {
        display: block;
      }

      .btn-admin {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-size: 1rem;
        border-radius: 50px;
        cursor: pointer;
        transition:
          transform 0.3s,
          box-shadow 0.3s;
        width: 100%;
        font-weight: 600;
        margin-top: 1rem;
      }

      .btn-admin:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-admin:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .menu-items-list {
        display: grid;
        gap: 1rem;
      }

      .menu-item-card {
        display: flex;
        gap: 1rem;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        align-items: center;
        transition: transform 0.2s;
      }

      .menu-item-card:hover {
        transform: translateX(5px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .menu-item-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        background: #e0e0e0;
      }

      .menu-item-info {
        flex: 1;
      }

      .menu-item-info h3 {
        margin: 0 0 0.3rem 0;
        color: #333;
        font-size: 1.1rem;
      }

      .menu-item-info p {
        margin: 0 0 0.5rem 0;
        color: #666;
        font-size: 0.9rem;
      }

      .menu-item-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
      }

      .menu-item-meta span {
        background: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
      }

      .menu-item-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .btn-small {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
        font-weight: 600;
      }

      .btn-edit {
        background: #4caf50;
        color: white;
      }

      .btn-edit:hover {
        background: #45a049;
      }

      .btn-delete {
        background: #f44336;
        color: white;
      }

      .btn-delete:hover {
        background: #da190b;
      }

      .btn-toggle {
        background: #ff9800;
        color: white;
      }

      .btn-toggle:hover {
        background: #e68900;
      }

      .status-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .status-available {
        background: #d4edda;
        color: #155724;
      }

      .status-unavailable {
        background: #f8d7da;
        color: #721c24;
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
      }

      .loading-spinner.show {
        display: block;
      }

      .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
      }

      .alert.show {
        display: block;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .empty-state {
        text-align: center;
        padding: 3rem;
        color: #999;
      }

      .empty-state svg {
        width: 100px;
        height: 100px;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      @media (max-width: 968px) {
        .admin-grid {
          grid-template-columns: 1fr;
        }

        .menu-item-card {
          flex-direction: column;
          text-align: center;
        }

        .menu-item-actions {
          flex-direction: row;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1>üçΩÔ∏è Admin Panel</h1>
        <p>Manage your restaurant menu items</p>
      </div>

      <div id="alertBox" class="alert"></div>

      <div class="admin-grid">
        <!-- Add/Edit Menu Item Form -->
        <div class="admin-card">
          <h2 id="formTitle">‚ûï Add New Menu Item</h2>
          <form id="menuItemForm">
            <input type="hidden" id="itemId" value="" />

            <div class="form-group">
              <label for="itemName">Item Name *</label>
              <input
                type="text"
                id="itemName"
                required
                placeholder="e.g., Margherita Pizza"
              />
            </div>

            <div class="form-group">
              <label for="itemDescription">Description *</label>
              <textarea
                id="itemDescription"
                required
                placeholder="Describe your delicious item..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="itemPrice">Price ($) *</label>
              <input
                type="number"
                id="itemPrice"
                step="0.01"
                min="0"
                required
                placeholder="12.99"
              />
            </div>

            <div class="form-group">
              <label for="itemCategory">Category *</label>
              <select id="itemCategory" required>
                <option value="">Select Category</option>
                <option value="Pizza">Pizza</option>
                <option value="Burgers">Burgers</option>
                <option value="Salads">Salads</option>
                <option value="Sides">Sides</option>
                <option value="Desserts">Desserts</option>
                <option value="Beverages">Beverages</option>
                <option value="Pasta">Pasta</option>
                <option value="Sandwiches">Sandwiches</option>
              </select>
            </div>

            <div class="form-group">
              <label>Item Image</label>
              <div class="image-upload-area" id="imageUploadArea">
                <p>üì∏ Click or drag image here</p>
                <p style="font-size: 0.85rem; color: #999">
                  Recommended: 800x600px, Max: 5MB
                </p>
                <input
                  type="file"
                  id="itemImage"
                  accept="image/*"
                  style="display: none"
                />
                <img id="imagePreview" class="image-preview" alt="Preview" />
              </div>
            </div>

            <div class="form-group">
              <label for="itemAvailable">
                <input
                  type="checkbox"
                  id="itemAvailable"
                  checked
                  style="width: auto; margin-right: 0.5rem"
                />
                Available for ordering
              </label>
            </div>

            <button type="submit" class="btn-admin" id="submitBtn">
              <span id="btnText">‚ú® Add Menu Item</span>
              <span id="btnLoading" style="display: none"
                >‚è≥ Processing...</span
              >
            </button>

            <button
              type="button"
              class="btn-admin"
              id="cancelBtn"
              style="display: none; background: #999; margin-top: 0.5rem"
            >
              Cancel Edit
            </button>
          </form>
        </div>

        <!-- Menu Items List -->
        <div class="admin-card">
          <h2>üìã Current Menu Items</h2>
          <div class="loading-spinner" id="loadingSpinner">
            <p>‚è≥ Loading menu items...</p>
          </div>
          <div id="menuItemsList"></div>
        </div>
      </div>
    </div>

    <script src="/js/utils.js"></script>
    <script>
      let editingItemId = null;

      // Image upload handling
      const imageUploadArea = document.getElementById("imageUploadArea");
      const itemImage = document.getElementById("itemImage");
      const imagePreview = document.getElementById("imagePreview");

      imageUploadArea.addEventListener("click", () => itemImage.click());

      imageUploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        imageUploadArea.classList.add("dragover");
      });

      imageUploadArea.addEventListener("dragleave", () => {
        imageUploadArea.classList.remove("dragover");
      });

      imageUploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        imageUploadArea.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          itemImage.files = e.dataTransfer.files;
          previewImage(file);
        }
      });

      itemImage.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          previewImage(file);
        }
      });

      function previewImage(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.src = e.target.result;
          imagePreview.classList.add("show");
        };
        reader.readAsDataURL(file);
      }

      // Load menu items
      async function loadMenuItems() {
        const loadingSpinner = document.getElementById("loadingSpinner");
        const menuItemsList = document.getElementById("menuItemsList");

        loadingSpinner.classList.add("show");
        menuItemsList.innerHTML = "";

        try {
          const response = await fetchWithRetry("/api/menu");
          const data = await response.json();

          if (data.success && data.data.items.length > 0) {
            menuItemsList.innerHTML = data.data.items
              .map(
                (item) => `
                        <div class="menu-item-card" data-id="${item.id}">
                            <img src="${item.image || "/images/placeholder.jpg"}" 
                                 alt="${item.name}" 
                                 class="menu-item-image"
                                 onerror="this.src='/images/placeholder.jpg'">
                            <div class="menu-item-info">
                                <h3>${item.name}</h3>
                                <p>${item.description}</p>
                                <div class="menu-item-meta">
                                    <span style="color: #667eea;">üí≤ $${item.price.toFixed(2)}</span>
                                    <span style="color: #764ba2;">üìÅ ${item.category}</span>
                                    <span class="status-badge ${item.is_available ? "status-available" : "status-unavailable"}">
                                        ${item.is_available ? "‚úÖ Available" : "‚ùå Unavailable"}
                                    </span>
                                </div>
                            </div>
                            <div class="menu-item-actions">
                                <button class="btn-small btn-edit" onclick="editItem(${item.id})">‚úèÔ∏è Edit</button>
                                <button class="btn-small btn-toggle" onclick="toggleAvailability(${item.id}, ${item.is_available})">
                                    ${item.is_available ? "üîΩ Hide" : "üîº Show"}
                                </button>
                                <button class="btn-small btn-delete" onclick="deleteItem(${item.id})">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `,
              )
              .join("");
          } else {
            menuItemsList.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3>No menu items yet</h3>
                            <p>Start by adding your first menu item!</p>
                        </div>
                    `;
          }
        } catch (error) {
          showAlert("Failed to load menu items: " + error.message, "error");
        } finally {
          loadingSpinner.classList.remove("show");
        }
      }

      // Add/Update menu item
      document
        .getElementById("menuItemForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const submitBtn = document.getElementById("submitBtn");
          const btnText = document.getElementById("btnText");
          const btnLoading = document.getElementById("btnLoading");

          submitBtn.disabled = true;
          btnText.style.display = "none";
          btnLoading.style.display = "inline";

          const formData = new FormData();
          formData.append("name", document.getElementById("itemName").value);
          formData.append(
            "description",
            document.getElementById("itemDescription").value,
          );
          formData.append("price", document.getElementById("itemPrice").value);
          formData.append(
            "category",
            document.getElementById("itemCategory").value,
          );
          formData.append(
            "is_available",
            document.getElementById("itemAvailable").checked ? 1 : 0,
          );

          const imageFile = document.getElementById("itemImage").files[0];
          if (imageFile) {
            formData.append("image", imageFile);
          }

          try {
            const url = editingItemId
              ? `/api/admin/menu/${editingItemId}`
              : "/api/admin/menu";

            const method = editingItemId ? "PUT" : "POST";

            const response = await fetch(url, {
              method: method,
              body: formData,
            });

            const data = await response.json();

            if (data.success) {
              showAlert(
                editingItemId
                  ? "‚úÖ Menu item updated successfully!"
                  : "‚úÖ Menu item added successfully!",
                "success",
              );
              resetForm();
              await loadMenuItems();
            } else {
              showAlert("‚ùå " + data.message, "error");
            }
          } catch (error) {
            showAlert("‚ùå Error: " + error.message, "error");
          } finally {
            submitBtn.disabled = false;
            btnText.style.display = "inline";
            btnLoading.style.display = "none";
          }
        });

      // Edit item
      async function editItem(id) {
        try {
          const response = await fetchWithRetry(`/api/menu/${id}`);
          const data = await response.json();

          if (data.success) {
            const item = data.data;
            editingItemId = id;

            document.getElementById("itemId").value = id;
            document.getElementById("itemName").value = item.name;
            document.getElementById("itemDescription").value = item.description;
            document.getElementById("itemPrice").value = item.price;
            document.getElementById("itemCategory").value = item.category;
            document.getElementById("itemAvailable").checked =
              item.is_available === 1;

            if (item.image) {
              imagePreview.src = item.image;
              imagePreview.classList.add("show");
            }

            document.getElementById("formTitle").textContent =
              "‚úèÔ∏è Edit Menu Item";
            document.getElementById("btnText").textContent =
              "üíæ Update Menu Item";
            document.getElementById("cancelBtn").style.display = "block";

            // Scroll to form
            document
              .querySelector(".admin-card")
              .scrollIntoView({ behavior: "smooth" });
          }
        } catch (error) {
          showAlert("‚ùå Failed to load item: " + error.message, "error");
        }
      }

      // Toggle availability
      async function toggleAvailability(id, currentStatus) {
        try {
          const response = await fetch(`/api/admin/menu/${id}/toggle`, {
            method: "PATCH",
          });

          const data = await response.json();

          if (data.success) {
            showAlert("‚úÖ Availability updated!", "success");
            await loadMenuItems();
          } else {
            showAlert("‚ùå " + data.message, "error");
          }
        } catch (error) {
          showAlert("‚ùå Error: " + error.message, "error");
        }
      }

      // Delete item
      async function deleteItem(id) {
        if (!confirm("Are you sure you want to delete this menu item?")) {
          return;
        }

        try {
          const response = await fetch(`/api/admin/menu/${id}`, {
            method: "DELETE",
          });

          const data = await response.json();

          if (data.success) {
            showAlert("‚úÖ Menu item deleted successfully!", "success");
            await loadMenuItems();
          } else {
            showAlert("‚ùå " + data.message, "error");
          }
        } catch (error) {
          showAlert("‚ùå Error: " + error.message, "error");
        }
      }

      // Reset form
      function resetForm() {
        document.getElementById("menuItemForm").reset();
        document.getElementById("itemId").value = "";
        editingItemId = null;
        imagePreview.classList.remove("show");
        imagePreview.src = "";
        document.getElementById("formTitle").textContent =
          "‚ûï Add New Menu Item";
        document.getElementById("btnText").textContent = "‚ú® Add Menu Item";
        document.getElementById("cancelBtn").style.display = "none";
      }

      document.getElementById("cancelBtn").addEventListener("click", resetForm);

      // Show alert
      function showAlert(message, type) {
        const alertBox = document.getElementById("alertBox");
        alertBox.textContent = message;
        alertBox.className = `alert alert-${type} show`;
        setTimeout(() => {
          alertBox.classList.remove("show");
        }, 5000);
      }

      // Load menu items on page load
      loadMenuItems();
    </script>
  </body>
</html>
